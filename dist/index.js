/* yocto-render - A renderer utility tool for yocto core stack - V1.2.4 */

"use strict";var _=require("lodash"),uuid=require("uuid"),logger=require("yocto-logger"),joi=require("joi"),utils=require("yocto-utils"),cryptoJs=require("crypto-js"),moment=require("moment"),base64=require("js-base64").Base64;function Render(e){this.defaultConfig={app:{name:[uuid.v4(),"new-app"].join("-")},property:{title:"",language:"en",meta:[],assets:{},httpEquiv:[]}},this.uuid=uuid.v4(),this.config=_.clone(this.defaultConfig),this.debug=!1,this.logger=e}Render.prototype.buildFingerprint=function(e,i,t){var n=cryptoJs.HmacSHA256(moment().format(i),e).toString();return t=t>_.size(n)||t<=0?_.size(n):t,_.isNumber(t)?_.truncate(n,{length:t,omission:""}):n},Render.prototype.buildAssetKeyValue=function(e,i,t,n,o){return!(!_.has(e,o)||!_.isArray(e[o])||_.isEmpty(e[o]))&&(_.each(e[o],function(e){var o=_.clone(e);if((_.isUndefined(n)?_.has(o,t)&&!_.isEmpty(o[t]):_.has(o,t)&&_.has(o,n)&&!_.isEmpty(o[t])&&!_.isEmpty(o[n]))&&_.isArray(i)&&!_.isUndefined(i)&&!_.isNull(i)){if(_.has(o,"base64.enable")&&o.base64.enable&&(_.includes(o.link,[o.base64.qs,"="].join(""))?this.logger.warning(["[ Render.buildAssetKeyValue ] -","Cannot encode ressource [",o.link,"] to base 64 because the query string [",o.base64.qs,"] already exists. Update your configuration and setup the base64","query string to another value"].join(" ")):o.link=[o.base64.qs,"=",base64.encode(o.link)].join("")),_.startsWith(o.link,"?")&&(o.link=o.link.substr(1,o.link.length)),o.link=[o.host,o.link].join([_.startsWith(o.link,"/")||_.startsWith(o.link,"https")||_.startsWith(o.link,"http")?"":"/",_.isEmpty(o.host)||_.isEmpty(o.link)||_.startsWith(o.link,"?")||_.endsWith(o.link,"?")?"":"?"].join("")),_.has(o,"fingerprint.enable")&&o.fingerprint.enable){var r=_.includes(o.link,"?")?"&":"?";o.link=[o.link,r,o.fingerprint.qs,"=",this.buildFingerprint(o.fingerprint.key,o.fingerprint.dateFormat,o.fingerprint.limit)].join("")}delete o.fingerprint,delete o.base64,delete o.host,i.push(o)}}.bind(this)),!0)},Render.prototype.buildSimpleKeyValue=function(e,i,t,n){return _.each(e,function(e){_.has(e,t)&&_.has(e,n)&&!_.isEmpty(e[t])&&!_.isEmpty(e[n])&&i.push(e)}),!0},Render.prototype.updateConfig=function(e){var i=joi.object().keys({name:joi.string().required().not(null),value:joi.string().required().not(null)}),t=joi.object().keys({host:joi.string().uri({scheme:["http","https"]}).optional().empty(),link:joi.string().required().not(null),media:joi.string().required().not(null),defer:joi.string().optional().allow("defer").not(null),async:joi.string().optional().allow("async").not(null),fingerprint:joi.object().optional().keys({enable:joi.boolean().required().default(!1),key:joi.string().optional().default(this.uuid),dateFormat:joi.string().optional().default("DD/MM/YYYY"),qs:joi.string().optional().empty().default("f"),limit:joi.number().optional().min(1)}),base64:joi.object().optional().keys({enable:joi.boolean().required().default(!1),qs:joi.string().optional().empty().default("b")})}),n=joi.object().keys({host:joi.string().uri({scheme:["http","https"]}).optional().empty(),link:joi.string().required().not(null),defer:joi.string().optional().allow("defer").not(null),async:joi.string().optional().allow("async").not(null),fingerprint:joi.object().optional().keys({enable:joi.boolean().required().default(!1),key:joi.string().optional().default(this.uuid),dateFormat:joi.string().optional().default("DD/MM/YYYY"),qs:joi.string().optional().empty().default("f"),limit:joi.number().optional().min(1)}),base64:joi.object().optional().keys({enable:joi.boolean().required().default(!1),qs:joi.string().optional().empty().default("b")})}),o={css:joi.array().optional().min(1).items(t),js:joi.array().optional().min(1).items(n)},r={header:joi.object().optional().min(1).keys(o),footer:joi.object().optional().min(1).keys(o)},a={property:joi.string().required().empty(),content:joi.string().required().empty()},s={rel:joi.string().required().empty(),href:joi.string().required().empty()},l={facebook:joi.array().optional().items(a).default([]),twitter:joi.array().optional().items(a).default([]),google:joi.array().optional().items(s).default([])},u=joi.object().required().keys({app:joi.object().optional().min(1).keys({name:joi.string().required().min(3).not(null).empty()}),property:joi.object().optional().min(1).keys({title:joi.string().optional().min(3).not(null),language:joi.string().optional().length(2).not(null),meta:joi.array().optional().min(1).items(i),httpEquiv:joi.array().optional().min(1).items(i),assets:joi.object().optional().min(1).keys(r),mobileIcons:joi.array().optional().min(1).items(joi.object().required().keys({rel:joi.string().required().empty(),sizes:joi.string().required().empty(),href:joi.string().required().empty()})),social:joi.object().optional().min(1).keys(l)})}).allow(["app","property"]),p=joi.validate(e,u,{abortEarly:!1});return _.isNull(p.error)?_.merge(this.config,p.value):_.has(p.error,"details")&&_.isArray(p.error.details)&&_.each(p.error.details,function(e){this.logger.warning(["[ Render.updateConfig ] -","Cannot validate given config.","Error is [",e.message,"] on [",e.path,"]"].join(" "))}.bind(this)),_.isEmpty(p.error)||_.isNull(p.error)},Render.prototype.build=function(e){if("header"===e||"footer"===e){var i={appname:this.config.app.name,title:this.config.property.title,language:this.config.property.language||this.defaultConfig.property.language},t={css:[],js:[]},n=[{reference:this.config.property.assets[e],destination:t.css,keyLabel:"link",valueLabel:"media",type:"assets",stype:"css"},{reference:this.config.property.assets[e],destination:t.js,keyLabel:"link",type:"assets",stype:"js"}];if("header"===e){var o=this.config.property.social||{};_.extend(t,{metas:[],httpEquiv:[],mobileIcons:this.config.property.mobileIcons||[],facebook:o.facebook||[],twitter:o.twitter||[],google:o.google||[]});var r=[{reference:this.config.property.meta,destination:t.metas,keyLabel:"name",valueLabel:"value"},{reference:this.config.property.httpEquiv,destination:t.httpEquiv,keyLabel:"name",valueLabel:"value"}];n.push(r),n=_.flatten(n)}return _.each(n,function(e){_.has(e,"type")&&"assets"===e.type?this.buildAssetKeyValue(e.reference,e.destination,e.keyLabel,e.valueLabel,e.stype):this.buildSimpleKeyValue(e.reference,e.destination,e.keyLabel,e.valueLabel)}.bind(this)),t=utils.obj.renameKey(t,"css",["css",_.capitalize(e)].join("")),t=utils.obj.renameKey(t,"js",["js",_.capitalize(e)].join("")),_.extend(i,t)}return this.logger.warning(["[ Render.build ] - Cannot build data for current type. given [",e,"] and waiting header OR footer value"].join("")),!1},Render.prototype.processRender=function(e,i,t,n,o,r){n=!!_.isBoolean(n)&&n,o=!!_.isBoolean(o)&&o,n&&this.noCacheHeader(e);var a=_.extend(this.build("header"),this.build("footer"));_.isUndefined(t)||_.isNull(t)||!_.isObject(t)||_.extend(a,t),o?(r=r||{},_.isUndefined(t)||_.isNull(t)||!_.isObject(t)||_.extend(r,t),this.debug&&(_.isObject(r)||(r={data:r}),_.extend(r,{header:_.get(e,"_headers")})),this.logger.debug("[ Render.processRender ] - Rendering only data. Data sent are :",r),e.send(r).end()):(this.logger.debug(["[ Render.processRender ] - Rendering tempate :",i].join(" ")),e.render(i,a))},Render.prototype.render=function(e,i,t,n){return this.processRender(e,i,t,n)},Render.prototype.renderOnlyData=function(e,i,t){return this.processRender(e,null,null,t,!0,i)},Render.prototype.noCacheHeader=function(e){return!(_.isUndefined(e.header)||!_.isFunction(e.header))&&(e.header("Cache-Control","private, no-cache, no-store, must-revalidate"),e.header("Expires","-1"),e.header("Pragma","no-cache"),!0)},module.exports=function(e){return(_.isUndefined(e)||_.isNull(e))&&(logger.warning("[ Render.constructor ] - Invalid logger given. Use internal logger"),e=logger),new Render(e)};