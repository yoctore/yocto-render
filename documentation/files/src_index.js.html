<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/index.js - yocto-render</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="yocto-render" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.2.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Render.html">Render</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/index.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

var _         = require(&#x27;lodash&#x27;);
var uuid      = require(&#x27;uuid&#x27;);
var logger    = require(&#x27;yocto-logger&#x27;);
var joi       = require(&#x27;joi&#x27;);
var utils     = require(&#x27;yocto-utils&#x27;);

/**
 * Yocto render manager. Manage your own render request
 *
 * A custom render wrapper to display default template value for a website
 * 
 * For more details on these dependencies read links below :
 * - LodAsh : https://lodash.com/
 * - uuid : https://www.npmjs.com/package/uuid
 * - yocto-logger : git+ssh://lab.yocto.digital/yocto-node-modules/yocto-render.git
 * - yocto-utils :  git+ssh://lab.yocto.digital/yocto-node-modules/yocto-utils.git
 * - joi : https://github.com/hapijs/joi
 *
 * For each examples, please read file on example directory.
 *
 * @date : 22/04/2015
 * @author : Mathieu ROBERT &lt;mathieu@yocto.re&gt;
 * @copyright : Yocto SAS, All right reserved
 * @class Render
 */

function Render() {
  /**
   * Default config object
   *
   * @property defaultConfig
   * @type Object
   */
  this.defaultConfig = {
    app : {
      name : [ uuid.v4(), &#x27;new-app&#x27; ].join(&#x27;-&#x27;)
    },
    render : {
      charset   : &#x27;utf-8&#x27;,
      title     : &#x27;&#x27;,
      language  : &#x27;en&#x27;,
      meta      : [],
      assets    : {},
      httpEquiv : []
    }
  };
  
  /**
   * Config object. a clone value of defaultConfig or customized by user
   *
   * @property config
   * @type Object
   */    
  this.config = _.clone(this.defaultConfig);
  
  /**
   * Debug state property. if false debug mode is disabled
   *
   * @property debug
   * @type Boolean
   * @default false
   */
  this.debug  = false;

  /**
   * Login property. By Default Render use his logger instance.
   * But we can set this value by a already yocto-logger instance 
   */
  this.logger = logger;

  /**
   * Build assets (js, css) for rendering
   * 
   * @method buildAssetKeyValue
   * @param {Object} reference reference object to use
   * @param {Array} destination array to store data before parse
   * @param {String} keyLabel main label to use on template
   * @param {String} valueLabel second label to use on template
   * @param {String} type to use on parse        
   */  
  this.buildAssetKeyValue = function(reference, destination, keyLabel, valueLabel, stype) {
    // structure is correct
    if (_.has(reference, stype) &amp;&amp; _.isArray(reference[stype]) &amp;&amp; !_.isEmpty(reference[stype])) {
      
      // parse all reference
      _.each(reference[stype], function(st) {
        
        // check ternaire
        var check = (!_.isUndefined(valueLabel) ? (_.has(st, keyLabel) &amp;&amp; _.has(st, valueLabel) &amp;&amp; !_.isEmpty(st[keyLabel]) &amp;&amp; !_.isEmpty(st[valueLabel])) : (_.has(st, keyLabel) &amp;&amp; !_.isEmpty(st[keyLabel])));

        // end check before add
        if (check &amp;&amp; _.isArray(destination) &amp;&amp; !_.isUndefined(destination) &amp;&amp; !_.isNull(destination)) {
          destination.push(st);
        }
      });    
    }
  };
  
  /**
   * Build simple key association for template
   * 
   * @method buildSimpleKeyValue
   * @param {Object} reference reference object to use
   * @param {Array} destination array to store data before parse
   * @param {String} keyLabel main label to use on template
   * @param {String} valueLabel second label to use on template
   */
  this.buildSimpleKeyValue  = function(reference, destination, keyLabel, valueLabel) {
    // parse item and assign if ok
    _.each(reference, function(ref) {
      if (_.has(ref, keyLabel) &amp;&amp; _.has(ref, valueLabel) &amp;&amp; !_.isEmpty(ref[keyLabel]) &amp;&amp; !_.isEmpty(ref[valueLabel])) {
        destination.push(ref);
      }    
    });    
  };
}

/**
 * Update config for rendering
 * 
 * @param {Object} value value to use on config
 */
Render.prototype.updateConfig = function(value) {
  // default process var. if true run merge at end of this function
  var process = true;

  // define meta rules
  var metaHttpEquivRules = joi.object().keys({
    name  : joi.string().required().not(null),
    value : joi.string().required().not(null) 
  });

  // setting css media rules
  var cssMediaRules = joi.object().keys({
    link  : joi.string().required().not(null),
    media : joi.string().required().not(null),
    defer : joi.string().optional().allow(&#x27;defer&#x27;).not(null),
    async : joi.string().optional().allow(&#x27;async&#x27;).not(null),        
  });

  // setting js media rules
  var jsMediaRules = joi.object().keys({
    link  : joi.string().required().not(null),
    defer : joi.string().optional().allow(&#x27;defer&#x27;).not(null),
    async : joi.string().optional().allow(&#x27;async&#x27;).not(null)        
  });

  // setting up media type rules
  var mediaTypeRules = {
    css : joi.array().optional().min(1).items(cssMediaRules),
    js : joi.array().optional().min(1).items(jsMediaRules)
  };

  // setting up assets rules
  var assetsRules = {
    header : joi.object().optional().min(1).keys(mediaTypeRules),
    footer : joi.object().optional().min(1).keys(mediaTypeRules)    
  };
  
  // define general schema
  var schema = joi.object().keys({
    app : joi.object().optional().min(1).keys({
      name : joi.string().required().min(3).not(null).empty()
    }),
    
    render : joi.object().optional().min(1).keys({
      charset   : joi.string().allow(&#x27;utf-8&#x27;).optional().not(null),
      title     : joi.string().optional().min(3).not(null),      
      language  : joi.string().optional().length(2).not(null),
      meta      : joi.array().optional().min(1).items(metaHttpEquivRules),
      httpEquiv : joi.array().optional().min(1).items(metaHttpEquivRules),
      assets    : joi.object().optional().min(1).keys(assetsRules)        
    })     
  });
      
  // validate rules
  var tests = joi.validate(value, schema, { abortEarly : false });

  // has errors ?
  if (!_.isNull(tests.error)) {
    // has some details on error ?
    if (_.has(tests.error, &#x27;details&#x27;)) {
      // checking details data 
      if (_.isArray(tests.error.details)) {

        // parse error details
        _.each(tests.error.details, function(error) {
          // check message property          
          if (_.has(error, &#x27;message&#x27;) &amp;&amp; _.has(error, &#x27;path&#x27;) &amp;&amp; !_.isEmpty(error.message) &amp;&amp; !_.isEmpty(error.path)) {
            var message = [ &#x27;[ Render.updateConfig ] - Cannot validate given config. Error is [&#x27;, error.message, &#x27;] on [&#x27;, error.path, &#x27;]&#x27; ].join(&#x27; &#x27;);
            // log message
            this.logger.warning(message);
          }            
        }, this);
      }
    }
  } else {
    // all is ok so merge it
    _.merge(this.config, value);
  }

  // return status 
  return _.isEmpty(tests.error) || _.isNull(tests.error);
};

/**
 * Build data to inject on header page
 * 
 * @method buildHeader
 * @return {Object} default object to return
 */ 
Render.prototype.build = function(type) {
  
  if (type == &#x27;header&#x27; || type == &#x27;footer&#x27;) {
    // build header data to inject on tempate
    var data = {
      appname   : this.config.app.name,
      charset   : (this.config.render.charset || this.defaultConfig.render.charset),
      title     : this.config.render.title,
      language  : (this.config.render.language || this.defaultConfig.render.language),     
    };
  
    // define common items to build  
    var obj = {
      css       : [],
      js        : []
    };
  
    // define simple rules for cheking
    var rules = [{
        reference   : this.config.render.assets[type],
        destination : obj.css,
        keyLabel    : &#x27;link&#x27;,
        valueLabel  : &#x27;media&#x27;,
        type        : &#x27;assets&#x27;,
        stype       : &#x27;css&#x27;
      }, {
        reference   : this.config.render.assets[type],
        destination : obj.js,
        keyLabel    : &#x27;link&#x27;,
        type        : &#x27;assets&#x27;,
        stype       : &#x27;js&#x27;
      }    
    ];
  
    // extend obj if is header type
    if (type == &#x27;header&#x27;) {
      _.extend(obj, { metas : [], httpEquiv : []});
      
      // define rule for header
      var r = [{
        reference   : this.config.render.meta,
        destination : obj.metas,
        keyLabel    : &#x27;name&#x27;,
        valueLabel  : &#x27;value&#x27;
      }, {
        reference   : this.config.render.httpEquiv,
        destination : obj.httpEquiv,
        keyLabel    : &#x27;name&#x27;,
        valueLabel  : &#x27;value&#x27;
      }];
      
      // merge rule
      rules.push(r);
      rules = _.flatten(rules);
    }
  
    // process rules
    _.each(rules, function(rule) {
      if (_.has(rule, &#x27;type&#x27;) &amp;&amp; rule.type == &#x27;assets&#x27;) {
        this.buildAssetKeyValue(rule.reference, rule.destination, rule.keyLabel, rule.valueLabel, rule.stype);
      } else {
          this.buildSimpleKeyValue(rule.reference, rule.destination, rule.keyLabel, rule.valueLabel);      
      }  
    }, this);
  
    // rename key for template
    obj = utils.renameKey(obj, &#x27;css&#x27;, [ &#x27;css&#x27;, _.capitalize(type) ].join(&#x27;&#x27;));
    obj = utils.renameKey(obj, &#x27;js&#x27;, [ &#x27;js&#x27;, _.capitalize(type) ].join(&#x27;&#x27;));
  
    // if header process 
    if (type == &#x27;header&#x27;) {
      // extending object with data
      _.extend(data, obj);    
    }
  
    // returning object
    return obj;
  } else {
      this.logger.warning([ &#x27;[ Render.build ] - Cannot build data for current type. given [&#x27;, type, &#x27;] and waiting header OR footer value&#x27;].join(&#x27;&#x27;));
  }
};

/**
 * Main rendering function. Render tempate or only data
 *
 * @param {String} template, current template path to display by rendered
 * @param {Object} param, current custom param to send on rendering
 * @param {Boolean} nocache, true if we need to use no cache header, false otherwise
 * @param {Boolean} onlydata, true if we need to send only data
 * @param {Object} data, object to send if we need only data. By default we need to use this param if we set onlydata param to true
 */
Render.prototype.processRender = function(res, template, param, nocache, onlydata, data) {
  // setting up cache if undefined
  nocache   = _.isBoolean(nocache) ? nocache : false;
  onlydata  = _.isBoolean(onlydata) ? onlydata : false;
  
  // use no cache header ?
  if (nocache) {
    this.noCacheHeader(res);
  }
  
  // build params
  var params = _.extend(this.build(&#x27;header&#x27;), this.build(&#x27;footer&#x27;));
  
  // is a valid param
  if (!_.isUndefined(param) &amp;&amp; !_.isNull(param) &amp;&amp; _.isObject(param)) {
    // extend params with default and custom param
    _.extend(params, param);    
  }
  
  // is only data request
  if (!onlydata) {
    this.logger.debug([ &#x27;[ Render.processRender ] - Rendering tempate :&#x27;, template ].join(&#x27; &#x27;));
    // rendering ?
    res.render(template, params);      
  } else {
    // if data is invalid set to default empty object
    data = data || {};

    // is a valid param
    if (!_.isUndefined(param) &amp;&amp; !_.isNull(param) &amp;&amp; _.isObject(param)) {
      // extend params with default and custom param
      _.extend(data, param);   
    }

    // if debug mode extend data with headers data for onlyd data mode    
    if (this.debug) {
      if (!_.isObject(data)) {
        data = { data : data }; 
      }
      
      // adding header on response
      _.extend(data, { header : res._headers });        
    }

    this.logger.debug(&#x27;[ Render.processRender ] - Rendering only data. Data sent are :&#x27;, data);    
    // send data
    res.send(data).end();  
  }
};

/**
 * Default render function. for template rendering
 *
 * @method render
 * @param {Object} res http response object
 * @param {String} template template name/path to use for display
 * @param {Object} param data to display
 * @param {Boolean} nocache true if we need no cache header, false otherwise 
 */
Render.prototype.render = function(res, template, param, nocache) {
  this.processRender(res, template, param, nocache);
};

/**
 * Wrapper data to render only data without template
 * 
 * @method renderOnlyData
 * @param {Object} res http response object
 * @param {Mixed} data data to display
 * @param {Boolean} nocache true if we need no cache header, false otherwise 
 */
Render.prototype.renderOnlyData = function(res, data, nocache) {
  this.processRender(res, null, null, nocache, true, data);
};

/**
 * Default no cache header function. Set header with no cache params
 * 
 * @method noCacheHeader
 * @param {Object} res http response
 */
Render.prototype.noCacheHeader = function(res) {
  // res has header method ??
  if (!_.isUndefined(res.header) &amp;&amp; _.isFunction(res.header)) {
    res.header(&#x27;Cache-Control&#x27;, &#x27;private, no-cache, no-store, must-revalidate&#x27;);
    res.header(&#x27;Expires&#x27;, &#x27;-1&#x27;);
    res.header(&#x27;Pragma&#x27;, &#x27;no-cache&#x27;);
  }
};

/**
 * Set a new value on render property given by name
 * 
 * @method set
 * @param {String} name name of property to set
 * @param {Mixed} value value of property to set
 * @return {Object} current instance of object
 */
Render.prototype.set = function(name, value) {
  // is logger change ??
  if (name != &#x27;logger&#x27;) {
    if (name != &#x27;config&#x27;) {
      this[name] = value;          
    } else {
        // update config
        this.updateConfig(value);
    }
  } else {
    // is a logger instance ?
    if (!_.isUndefined(value.constructor)) {
      // is a yocto-logger instance ?
      if (value.constructor == logger.constructor &amp;&amp; value.constructor.name == logger.constructor.name) {
    	  this[name] = value;
      } else {
        this.logger.warning(&#x27;[ Render.set ] - Invalid type of Logger given. This module only accept a valid yocto-logger instance. Operation aborted !&#x27;);
      }
    } else {
      this.logger.warning(&#x27;[ Render.set ] - Invalid Logger instance given. Operation aborted !&#x27;);
    }
  }
  
  // return current instance
  return this;
};

/**
 * exports render
 */
module.exports = new (Render)();

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
